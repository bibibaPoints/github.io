<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Point Redemption</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="src/css/main.css">
</head>
<body>
    <div class="container">
        <!-- Points Display -->
        <div class="points-total">
            Points: <span id="points">...</span>
        </div>
        <div class="admin-link">
            <a href="admin.html" target="_blank">ðŸ”‘ Admin Panel</a>
        </div>

        <!-- Main Content Wrapper -->
        <div class="content-wrapper">
            <!-- Rewards Section -->
            <div class="rewards-section">
                <h2>Available Rewards</h2>
                <div class="rewards-grid" id="rewards"></div>
            </div>

            <!-- Redemption History Section -->
            <div class="redemptions-section">
                <h2>Redemption History</h2>
                <table id="redemptions-table">
                    <thead>
                        <tr>
                            <th>Reward</th>
                            <th>Cost</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Filled dynamically by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Success Message -->
        <div id="success" class="success-msg"></div>
    </div>

    <!-- Firebase SDK -->
   <script type="module">
    // Import Firebase modules from CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Your Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyA1tsf2jHSpUfLb3PsFR58PJXDVhsGgHWA",
        authDomain: "bibibapoints.firebaseapp.com",
        projectId: "bibibapoints",
        storageBucket: "bibibapoints.firebasestorage.app",
        messagingSenderId: "942015302901",
        appId: "1:942015302901:web:f2118d13231e5bf98cc9bc",
        measurementId: "G-BG3FKHX8BF"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Firestore references
    const pointsDocRef = doc(db, "settings", "points");
    const rewardsColRef = collection(db, "rewards");
    const redemptionsColRef = collection(db, "redemptions");

    let points = 0;
    let rewards = [];

    // Load points
    async function loadPoints() {
        const pointsSnap = await getDoc(pointsDocRef);
        if (pointsSnap.exists()) {
            points = pointsSnap.data().value;
            document.getElementById('points').textContent = points.toLocaleString();
        }
    }

    // Load rewards (now sorts by price ascending)
    async function loadRewards() {
        const rewardsSnap = await getDocs(rewardsColRef);
        // map to include id and numeric cost for robust sorting/rendering
        rewards = rewardsSnap.docs.map(d => {
            const data = d.data();
            return {
                id: d.id,
                title: data.title ?? data.name ?? data.reward ?? '', // fallback field names if needed
                desc: data.desc ?? data.description ?? '',
                cost: Number(data.cost ?? 0)
            };
        });

        // sort by cost (lowest -> highest). Change `.sort((a,b)=>b.cost-a.cost)` for high->low
        rewards.sort((a, b) => a.cost - b.cost);

        renderRewards();
    }

    // Render rewards safely and attach event listeners (avoids inline onclick string escaping issues)
    function renderRewards() {
        const rewardsGrid = document.getElementById('rewards');
        rewardsGrid.innerHTML = '';

        if (rewards.length === 0) {
            rewardsGrid.innerHTML = '<div class="no-rewards">No rewards available.</div>';
            return;
        }

        rewards.forEach(reward => {
            const card = document.createElement('div');
            card.className = 'reward-card';

            const title = document.createElement('div');
            title.className = 'reward-title';
            title.textContent = reward.title;

            const desc = document.createElement('div');
            desc.className = 'reward-desc';
            desc.textContent = reward.desc;

            const pointsDiv = document.createElement('div');
            pointsDiv.className = 'reward-points';
            pointsDiv.textContent = `Cost: ${Number(reward.cost).toLocaleString()} points`;

            const btn = document.createElement('button');
            btn.className = 'redeem-btn';
            btn.type = 'button';
            btn.textContent = 'Redeem';
            // attach listener safely
            btn.addEventListener('click', () => window.redeem(reward.cost, reward.title));

            card.appendChild(title);
            card.appendChild(desc);
            card.appendChild(pointsDiv);
            card.appendChild(btn);

            rewardsGrid.appendChild(card);
        });
    }

    // Redeem a reward
    window.redeem = async function(cost, reward) {
        const successMsg = document.getElementById('success');
        if (points >= cost) {
            points -= cost;
            await updateDoc(pointsDocRef, { value: points });

            await addDoc(redemptionsColRef, {
                reward: reward,
                cost: cost,
                date: new Date().toISOString()
            });

            document.getElementById('points').textContent = points.toLocaleString();
            successMsg.textContent = `You redeemed: ${reward}!`;
            loadRedemptions();
        } else {
            successMsg.textContent = `Not enough points for ${reward}.`;
        }
    }

    // Load redemption history
    async function loadRedemptions() {
        const redemptionsSnap = await getDocs(redemptionsColRef);
        const tbody = document.querySelector('#redemptions-table tbody');
        tbody.innerHTML = '';
        redemptionsSnap.forEach(docSnap => {
            const data = docSnap.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${data.reward}</td>
                <td>${Number(data.cost).toLocaleString()}</td>
                <td>${new Date(data.date).toLocaleString()}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Initialize
    loadPoints();
    loadRewards();
    loadRedemptions();
</script>

</body>
</html>
